<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> ZORO - BY Sachin</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom font for a clean look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            --primary-color: #5d5dff; /* Indigo/Violet */
            --bg-color: #f7f9fc; /* Light Gray/Off-White */
            --card-bg: #ffffff;
            --text-color: #1f2937; /* Dark Gray */
            --creator-color: #2563eb; /* Blue */
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: scroll;
        }

        /* Scrollbar styling for chat history */
        #chat-history::-webkit-scrollbar {
            width: 4px;
        }

        #chat-history::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 2px;
        }

        .chat-bubble {
            max-width: 90%;
            margin-bottom: 1rem;
            border-radius: 1.25rem;
            padding: 0.75rem 1rem;
            line-height: 1.5;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .user-bubble {
            background-color: var(--primary-color);
            color: white;
            border-bottom-right-radius: 0.25rem;
        }

        .ai-bubble {
            background-color: var(--card-bg);
            border: 1px solid #e5e7eb;
            color: var(--text-color);
            border-bottom-left-radius: 0.25rem;
        }

        /* Input area styling */
        #input-area {
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.05), 0 -2px 4px -2px rgba(0, 0, 0, 0.05);
        }

        /* Subscription card styles */
        .price-card {
            transition: all 0.3s ease;
        }

        .price-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        
    </style>
</head>
<body class="flex flex-col">
    <!-- Main Application Container -->
    <div id="app-container" class="flex flex-col flex-grow">
        <!-- Top Navigation Bar (Hidden on Login) -->
        <header id="nav-header" class="hidden bg-white shadow-sm sticky top-0 z-10">
            <div class="flex items-center justify-between p-4 max-w-4xl mx-auto">
                <div class="flex items-center space-x-2">
                    <span class="font-extrabold text-lg text-gray-800">AI /</span>
                    <span class="text-sm font-medium text-gray-500">by <span class="text-indigo-600 font-semibold">Sachin</span></span>
                </div>
                <button onclick="toggleSidebar()" class="p-2 rounded-full hover:bg-gray-100 focus:outline-none">
                    <i data-lucide="menu" class="w-6 h-6 text-gray-600"></i>
                </button>
            </div>
        </header>

        <!-- Sidebar / Navigation Overlay -->
        <div id="sidebar" class="fixed inset-0 bg-black bg-opacity-50 z-50 transform -translate-x-full transition-transform duration-300 ease-in-out" onclick="toggleSidebar()">
            <div class="w-64 bg-white h-full shadow-2xl p-6" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-xl font-bold text-gray-800">Menu</h2>
                    <button onclick="toggleSidebar()" class="p-1 rounded-full hover:bg-gray-100">
                        <i data-lucide="x" class="w-6 h-6 text-gray-500"></i>
                    </button>
                </div>
                
                <nav class="space-y-3">
                    <button onclick="navigateTo('chat'); toggleSidebar();" class="flex items-center w-full p-3 rounded-xl text-left text-gray-700 hover:bg-indigo-50 transition duration-150">
                        <i data-lucide="message-square" class="w-5 h-5 mr-3"></i>
                        AI Chat
                    </button>
                    <button onclick="navigateTo('profile'); toggleSidebar();" class="flex items-center w-full p-3 rounded-xl text-left text-gray-700 hover:bg-indigo-50 transition duration-150">
                        <i data-lucide="user" class="w-5 h-5 mr-3"></i>
                        Profile
                    </button>
                    <button onclick="navigateTo('pricing'); toggleSidebar();" class="flex items-center w-full p-3 rounded-xl text-left text-gray-700 hover:bg-indigo-50 transition duration-150">
                        <i data-lucide="zap" class="w-5 h-5 mr-3"></i>
                        Subscriptions
                    </button>
                    <button onclick="handleLogout()" id="logout-button" class="flex items-center w-full p-3 rounded-xl text-left text-red-600 hover:bg-red-50 transition duration-150">
                        <i data-lucide="log-out" class="w-5 h-5 mr-3"></i>
                        Sign Out
                    </button>
                </nav>
            </div>
        </div>

        <!-- View Rendering Area -->
        <main class="flex-grow max-w-4xl mx-auto w-full">
            <!-- 1. Login View -->
            <div id="login-view" class="view flex flex-col items-center justify-center min-h-screen p-6 text-center">
                <div class="bg-white p-8 sm:p-10 rounded-2xl shadow-xl w-full max-w-sm">
                    <i data-lucide="sparkles" class="w-12 h-12 text-indigo-600 mx-auto mb-4"></i>
                    <h1 class="text-3xl font-bold text-gray-800 mb-2">Welcome to ZORO AI by Sachin</h1>
                    <p class="text-gray-500 mb-8">Your powerful AI assistant.</p>
                    <button onclick="handleLogin()" id="sign-in-button" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-xl hover:bg-indigo-700 transition duration-200 shadow-md">
                        Sign In Anonymously
                    </button>
                    <p class="mt-4 text-sm text-gray-400">Creator: Sachin</p>
                </div>
            </div>

            <!-- 2. Chat View -->
            <div id="chat-view" class="view hidden flex-col h-full pt-4 pb-20 sm:pb-4 relative">
                <div id="chat-history" class="flex-grow overflow-y-auto p-4 sm:p-6 space-y-4">
                    <!-- Initial welcome message -->
                    <div class="flex justify-start">
                        <div class="ai-bubble">
                            <i data-lucide="gemini" class="w-4 h-4 inline mr-2 text-indigo-500"></i>
                            Hello! I am ZORO your AI Assistant. What can I help you with today?
                        </div>
                    </div>
                    <!-- Messages will be appended here -->
                </div>

                <!-- Loading Indicator -->
                <div id="loading-indicator" class="hidden text-center p-2 text-sm text-gray-500">
                    <span class="animate-pulse">ZORO is thinking...</span>
                </div>
                
                <!-- Input Area -->
                <div id="input-area" class="fixed bottom-0 left-0 right-0 bg-white p-4">
                    <div class="max-w-4xl mx-auto flex space-x-3">
                        <input type="text" id="user-prompt" placeholder="Ask the ZORO anything..." 
                               class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                        <button onclick="sendMessage()" id="send-button"
                                class="bg-indigo-600 text-white p-3 rounded-xl hover:bg-indigo-700 transition duration-150 active:scale-95 disabled:bg-indigo-300">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 3. Profile View -->
            <div id="profile-view" class="view hidden p-6 sm:pt-12">
                <h2 class="text-3xl font-bold mb-8 text-gray-800 border-b pb-2">User Profile</h2>
                
                <div class="bg-white p-6 sm:p-8 rounded-xl shadow-lg space-y-6">
                    <div class="flex items-center space-x-4 border-b pb-4">
                        <div class="w-16 h-16 rounded-full bg-indigo-100 flex items-center justify-center">
                            <i data-lucide="user" class="w-8 h-8 text-indigo-600"></i>
                        </div>
                        <div>
                            <p class="text-xl font-semibold" id="profile-user-id-display">Loading User ID...</p>
                            <p class="text-sm text-gray-500">Status: Signed In Anonymously</p>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 class="text-lg font-semibold text-gray-700">Account Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-500">User ID (Full)</p>
                                <p class="font-mono text-sm break-all" id="user-id-full">N/A</p>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-lg">
                                <p class="text-xs text-gray-500">Current Subscription</p>
                                <p class="text-sm font-medium text-indigo-600" id="current-subscription">Free Tier</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pt-4">
                        <button onclick="navigateTo('pricing')" class="w-full bg-green-500 text-white font-semibold py-3 rounded-xl hover:bg-green-600 transition duration-200">
                            Upgrade Subscription
                        </button>
                    </div>
                </div>
            </div>

            <!-- 4. Pricing View -->
            <div id="pricing-view" class="view hidden p-6 sm:pt-12">
                <h2 class="text-3xl font-bold mb-3 text-gray-800">Choose Your Plan</h2>
                <p class="text-gray-500 mb-10">Budget-friendly plans for Indian users. Unlock unlimited potential.</p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Weekly Plan -->
                    <div class="price-card bg-white p-8 rounded-2xl shadow-lg border border-gray-100 flex flex-col justify-between">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Weekly Pass</h3>
                            <p class="text-gray-500 mb-6">Short-term access for project work.</p>
                            <div class="text-4xl font-extrabold text-indigo-600 mb-6">
                                ₹49
                                <span class="text-lg font-medium text-gray-400">/ week</span>
                            </div>
                            <ul class="space-y-3 text-gray-700 mb-8">
                                <li class="flex items-center"><i data-lucide="check" class="w-5 h-5 text-green-500 mr-2"></i> 7 Days Unlimited Access</li>
                                <li class="flex items-center"><i data-lucide="check" class="w-5 h-5 text-green-500 mr-2"></i> Fast Response Time</li>
                                <li class="flex items-center"><i data-lucide="x" class="w-5 h-5 text-red-400 mr-2"></i> Standard Priority Support</li>
                            </ul>
                        </div>
                        <button class="w-full bg-indigo-100 text-indigo-700 font-semibold py-3 rounded-xl hover:bg-indigo-200 transition duration-200">
                            Select Weekly
                        </button>
                    </div>

                    <!-- Monthly Plan (Most Popular) -->
                    <div class="price-card bg-indigo-600 p-8 rounded-2xl shadow-2xl border-4 border-indigo-400 transform scale-105 flex flex-col justify-between">
                        <div class="text-white">
                            <span class="bg-yellow-400 text-black text-xs font-bold px-3 py-1 rounded-full mb-3 inline-block">MOST POPULAR</span>
                            <h3 class="text-xl font-bold mb-2">Monthly Power</h3>
                            <p class="opacity-80 mb-6">Continuous power for daily use.</p>
                            <div class="text-4xl font-extrabold mb-6">
                                ₹199
                                <span class="text-lg font-medium opacity-70">/ month</span>
                            </div>
                            <ul class="space-y-3 mb-8">
                                <li class="flex items-center"><i data-lucide="check" class="w-5 h-5 text-yellow-300 mr-2"></i> Monthly Renewal</li>
                                <li class="flex items-center"><i data-lucide="check" class="w-5 h-5 text-yellow-300 mr-2"></i> Priority Access</li>
                                <li class="flex items-center"><i data-lucide="check" class="w-5 h-5 text-yellow-300 mr-2"></i> Advanced Features Unlocked</li>
                            </ul>
                        </div>
                        <button class="w-full bg-white text-indigo-700 font-bold py-3 rounded-xl hover:bg-gray-200 transition duration-200">
                            Go Monthly
                        </button>
                    </div>

                    <!-- Yearly Plan -->
                    <div class="price-card bg-white p-8 rounded-2xl shadow-lg border border-gray-100 flex flex-col justify-between">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">Yearly Pro</h3>
                            <p class="text-gray-500 mb-6">Best value! Save over 15%.</p>
                            <div class="text-4xl font-extrabold text-indigo-600 mb-6">
                                ₹1999
                                <span class="text-lg font-medium text-gray-400">/ year</span>
                            </div>
                            <ul class="space-y-3 text-gray-700 mb-8">
                                <li class="flex items-center"><i data-lucide="check" class="w-5 h-5 text-green-500 mr-2"></i> Max Savings (₹166/month)</li>
                                <li class="flex items-center"><i data-lucide="check" class="w-5 h-5 text-green-500 mr-2"></i> All Monthly Benefits</li>
                                <li class="flex items-center"><i data-lucide="check" class="w-5 h-5 text-green-500 mr-2"></i> Dedicated Support Channel</li>
                            </ul>
                        </div>
                        <button class="w-full bg-indigo-100 text-indigo-700 font-semibold py-3 rounded-xl hover:bg-indigo-200 transition duration-200">
                            Go Yearly
                        </button>
                    </div>
                </div>

                <p class="text-center text-sm text-gray-400 mt-12">All prices are in Indian Rupees (₹). Creator: Sachin.</p>
            </div>
            
            <!-- Floating Message Box (for alerts/confirmations) -->
            <div id="message-box" class="fixed top-5 left-1/2 -translate-x-1/2 w-80 p-4 rounded-xl shadow-2xl bg-white border border-gray-200 hidden z-50 transition-all duration-300 transform scale-95 opacity-0">
                <p id="message-text" class="text-center text-gray-800"></p>
                <div class="flex justify-center mt-3">
                    <button onclick="hideMessage()" class="bg-indigo-500 text-white text-sm px-4 py-2 rounded-lg hover:bg-indigo-600">
                        OK
                    </button>
                </div>
            </div>
            
        </main>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Global Variables and Configuration ---
        const apiKey = ""; // API key is handled by the environment
        const modelName = "gemini-2.5-flash-preview-09-2025";
        const apiUrlBase = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

        // Global Firebase instances
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;

        // Ensure global variables are defined or default
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Initialization and Auth Logic ---
        function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                showMessage("Firebase configuration error. Cannot initialize app.", "error");
                return;
            }

            try {
                // Set debug logging for Firestore/Auth
                setLogLevel('Debug');
                
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 1. Initial Authentication Check
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated:", userId);
                        isAuthReady = true;
                        
                        // Update UI and navigate to chat
                        updateAuthUI(true);
                        navigateTo('chat');

                    } else if (initialAuthToken) {
                        // 2. Use Custom Token if provided
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            console.error("Custom token sign-in failed. Attempting anonymous sign-in.", error);
                            // 3. Fallback to Anonymous Sign-in (If custom token fails)
                            await signInAnonymously(auth);
                        }
                    } else {
                        // 4. Default to Anonymous Sign-in
                        await signInAnonymously(auth);
                    }
                });
                
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("Failed to connect to backend services.", "error");
            }
        }

        // --- View Management ---
        window.currentView = 'login';
        const views = {
            'login': document.getElementById('login-view'),
            'chat': document.getElementById('chat-view'),
            'profile': document.getElementById('profile-view'),
            'pricing': document.getElementById('pricing-view'),
        };
        const navHeader = document.getElementById('nav-header');
        const sidebar = document.getElementById('sidebar');

        window.navigateTo = function(viewName) {
            if (!views[viewName] || (viewName !== 'login' && !isAuthReady)) {
                showMessage("Please sign in first.", "info");
                return;
            }

            window.currentView = viewName;

            // Show/Hide Header
            if (viewName === 'login') {
                navHeader.classList.add('hidden');
            } else {
                navHeader.classList.remove('hidden');
            }
            
            // Render all lucide icons in the new view
            lucide.createIcons();

            // Toggle Views
            Object.keys(views).forEach(key => {
                views[key].classList.add('hidden');
            });
            views[viewName].classList.remove('hidden');

            // Specific View Logic
            if (viewName === 'profile') {
                updateProfileView();
            }
            if (viewName === 'chat') {
                 // Ensure chat area is visible and input is focused
                 setTimeout(() => {
                    const chatHistory = document.getElementById('chat-history');
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                    document.getElementById('user-prompt').focus();
                 }, 100);
            }
        }

        function toggleSidebar() {
            sidebar.classList.toggle('-translate-x-full');
        }
        window.toggleSidebar = toggleSidebar; // Expose to global scope

        function updateAuthUI(isLoggedIn) {
            if (isLoggedIn) {
                views['login'].classList.add('hidden');
                document.getElementById('profile-user-id-display').textContent = `User: ${userId.substring(0, 8)}...`;
                document.getElementById('user-id-full').textContent = userId;
            } else {
                views['login'].classList.remove('hidden');
                navigateTo('login');
            }
        }
        
        function updateProfileView() {
            if (userId) {
                document.getElementById('profile-user-id-display').textContent = `User: ${userId.substring(0, 8)}...`;
                document.getElementById('user-id-full').textContent = userId;
            }
        }

        // --- User Interaction / Auth Simulation ---

        window.handleLogin = function() {
            // This button primarily handles the anonymous sign-in flow if it hasn't happened yet.
            // Since initFirebase() automatically signs in anonymously, this button serves as a re-try
            // or a manual trigger for the user if they land on the login page.
            if (!auth || !auth.currentUser) {
                signInAnonymously(auth)
                    .catch(error => {
                        console.error("Manual anonymous sign-in failed:", error);
                        showMessage("Failed to sign in. Check console for details.", "error");
                    });
            } else {
                navigateTo('chat');
            }
        }

        window.handleLogout = async function() {
            try {
                await signOut(auth);
                userId = null;
                isAuthReady = false;
                updateAuthUI(false);
                showMessage("Signed out successfully.", "info");
            } catch (error) {
                console.error("Sign out error:", error);
                showMessage("Error during sign out.", "error");
            }
            toggleSidebar();
        }

        // --- Chat UI & API Logic ---

        function showMessage(text) {
            const messageBox = document.getElementById('message-box');
            document.getElementById('message-text').textContent = text;
            messageBox.classList.remove('hidden', 'scale-95', 'opacity-0');
            messageBox.classList.add('scale-100', 'opacity-100');
            
            // Auto hide after 5 seconds
            setTimeout(hideMessage, 5000);
        }

        window.hideMessage = function() {
            const messageBox = document.getElementById('message-box');
            messageBox.classList.remove('scale-100', 'opacity-100');
            messageBox.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 300); // Wait for transition to finish
        }

        function appendMessage(sender, text) {
            const chatHistory = document.getElementById('chat-history');
            const messageContainer = document.createElement('div');
            messageContainer.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${sender === 'user' ? 'user-bubble' : 'ai-bubble'}`;
            
            // Simple markdown/formatting support for AI response
            let formattedText = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
            formattedText = formattedText.replace(/(\r\n|\n|\r)/gm, '<br>'); // Newlines
            formattedText = formattedText.replace(/`/g, '<code>'); // Code tags (simple)
            
            if (sender === 'ai') {
                 formattedText = `<i data-lucide="gemini" class="w-4 h-4 inline mr-2 text-indigo-500"></i>${formattedText}`;
            }

            bubble.innerHTML = formattedText;
            messageContainer.appendChild(bubble);
            chatHistory.appendChild(messageContainer);
            
            // Auto-scroll to bottom
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // Re-render lucide icons in the new message
            lucide.createIcons();
        }

        window.sendMessage = async function() {
            const promptInput = document.getElementById('user-prompt');
            const prompt = promptInput.value.trim();

            if (!prompt) return;

            if (!isAuthReady || !userId) {
                showMessage("Please wait for authentication to complete.", "info");
                return;
            }

            // Append user message
            appendMessage('user', prompt);
            promptInput.value = '';

            const sendButton = document.getElementById('send-button');
            const loadingIndicator = document.getElementById('loading-indicator');
            
            sendButton.disabled = true;
            loadingIndicator.classList.remove('hidden');

            try {
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    tools: [{ "google_search": {} }],
                    systemInstruction: {
                        parts: [{ text: "You are a helpful and concise AI assistant named 'ZORO'. A powerful character from one piece anime Keep your answers brief and use simple Markdown for emphasis like Zoro in anime. Respond in a friendly and professional tone. When asked about your creator, clearly state 'Sachin'." }]
                    },
                };

                const MAX_RETRIES = 5;
                for (let i = 0; i < MAX_RETRIES; i++) {
                    try {
                        const response = await fetch(apiUrlBase, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`API returned status ${response.status}`);
                        }

                        const result = await response.json();
                        const candidate = result.candidates?.[0];
                        
                        if (candidate && candidate.content?.parts?.[0]?.text) {
                            appendMessage('ai', candidate.content.parts[0].text);
                            break; // Success, exit retry loop
                        } else {
                            throw new Error("Invalid response structure from API.");
                        }

                    } catch (error) {
                        console.warn(`API call failed (Attempt ${i + 1}/${MAX_RETRIES}):`, error);
                        if (i === MAX_RETRIES - 1) {
                            // Last attempt failed
                            appendMessage('ai', "Sorry, I couldn't get a response right now. Please try again in a moment.");
                            throw error; // Re-throw to exit outer try-catch
                        }
                        // Exponential backoff
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            } catch (error) {
                console.error("Fatal error during message send:", error);
            } finally {
                sendButton.disabled = false;
                loadingIndicator.classList.add('hidden');
                // Auto-scroll one last time
                const chatHistory = document.getElementById('chat-history');
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        }

        // --- Initialization ---
        window.onload = () => {
            initFirebase();
            // Initial render of icons
            lucide.createIcons();
        };

    </script>
</body>
</html>

